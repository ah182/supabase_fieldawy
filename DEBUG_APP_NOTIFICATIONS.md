# ๐ ุชุตุญูุญ: ุงูุฅุดุนุงุฑุงุช ูุง ุชุนูู ูู ุงูุชุทุจูู

## โ ูุง ูุนูู:
- SQL command โ webhook ููุฑุณู โ ุฅุดุนุงุฑ ูุตู

## โ ูุง ูุง ูุนูู:
- ุฅุถุงูุฉ ูู ุงูุชุทุจูู โ ูุง ููุฌุฏ ุฅุดุนุงุฑ

---

## ๐ ุฎุทูุงุช ุงููุญุต ุงูุฏููู

### 1๏ธโฃ ุชุญูู ูู ุฃู Server ูุง ูุฒุงู ูุนูู

**ูู Terminal ุญูุซ `npm start`:**

ูู ูุง ุฒูุช ุชุดุงูุฏ:
```
๐ Notification webhook server is running on port 3000
```

- โ ูุนู โ ุงูุชูู ููุฎุทูุฉ 2
- โ ูุง โ ุดุบูู `npm start` ูุฑุฉ ุฃุฎุฑู

---

### 2๏ธโฃ ุชุญูู ูู ุฃู localtunnel ูุง ูุฒุงู ูุนูู

**ูู Terminal ุญูุซ `lt --port 3000`:**

ูู ูุง ุฒูุช ุชุดุงูุฏ:
```
your url is: https://little-mice-ask.loca.lt
```

- โ ูุนู โ ุงูุชูู ููุฎุทูุฉ 3
- โ ูุง โ ุดุบูู `lt --port 3000` ูุฑุฉ ุฃุฎุฑู

โ๏ธ **ููู:** ุฅุฐุง ุฃุนุฏุช ุชุดุบูู localtunnelุ ุณุชุญุตู ุนูู URL ุฌุฏูุฏ!
ูุฌุจ ุชุญุฏูุซ ุฌููุน webhooks ุจุงูู URL ุงูุฌุฏูุฏ!

---

### 3๏ธโฃ ุนูุฏ ุงูุฅุถุงูุฉ ูู ุงูุชุทุจูู - ุฑุงูุจ Terminal

**ุนูุฏ ุฅุถุงูุฉ ุฃุฏุงุฉ ูู ุงูุชุทุจูู:**

**ุงูุชุญ Terminal (ุญูุซ npm start) ูุฑุงูุจู:**

**ุงูุณููุงุฑูู A:** ุชุดุงูุฏ ุฑุณุงุฆู
```
๐ฉ ุชููู webhook ูู Supabase
   Table: distributor_surgical_tools
```

โ **ูุนูุงูุง:** Webhook ูุตู ููู ุงููุดููุฉ ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ
โ ุงูุชูู ููุฎุทูุฉ 4

---

**ุงูุณููุงุฑูู B:** ูุง ุชุดุงูุฏ ุฃู ุฑุณุงุฆู

โ **ูุนูุงูุง:** Webhook ูุง ูุตู ุฃุตูุงู
โ ุงูุชูู ููุฎุทูุฉ 5

---

### 4๏ธโฃ ุฅุฐุง Webhook ูุตู ููู ูุง ููุฌุฏ ุฅุดุนุงุฑ

**ุงููุดููุฉ:** FCM token issue

**ุงูุญู:**

#### ุฃ) ุชุญูู ูู Tokens ูู Supabase:

```sql
SELECT COUNT(*) FROM user_tokens WHERE updated_at > NOW() - INTERVAL '1 day';
```

**ุฅุฐุง ุงููุชูุฌุฉ 0:**
- ุณุฌูู ุฎุฑูุฌ ูู ุงูุชุทุจูู
- ุณุฌูู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู
- ุงูุชุธุฑ ุญุชู ุชุดุงูุฏ ูู console:
  ```
  โ ุชู ุญูุธ FCM Token ูู Supabase ุจูุฌุงุญ
  ```

#### ุจ) ุฌุฑุจ ุฅุฑุณุงู ูุฏูู:

```bash
node test_notification_direct.js
```

**ุฅุฐุง ูุตู ุฅุดุนุงุฑ:**
โ FCM ูุนููุ ุงููุดููุฉ ูู webhook payload

**ุฅุฐุง ูู ูุตู:**
โ ูุดููุฉ ูู ุงูุงุดุชุฑุงู ูู topic

---

### 5๏ธโฃ ุฅุฐุง Webhook ูุง ูุตู ุฃุตูุงู

**ุงูุญุต Webhook Logs ูู Supabase:**

**ุงูุฎุทูุงุช:**
1. Database > Webhooks
2. ุงุถุบุท ุนูู `distributor_surgical_tools_notifications`
3. ุงุฎุชุฑ **Logs** tab

**ุงูุณููุงุฑูู A:** Logs ูุงุฑุบุฉ
```
No logs found
```

โ **ุงูุณุจุจ:** Events ุบูุฑ ูุญุฏุฏุฉ ุฃู Webhook ูุนุทูู

**ุงูุญู:**
- ุชุญูู ูู ุฃู Status = Enabled
- ุชุญูู ูู ุฃู Events (Insert, Update) ูุญุฏุฏุฉ
- ุงุญุฐู webhook ูุฃุนุฏ ุฅูุดุงุกู

---

**ุงูุณููุงุฑูู B:** Logs ููุฌูุฏุฉ ุจู Status 404/500
```
Timestamp             Status
2025-01-08 11:30:00   404
```

โ **ุงูุณุจุจ:** URL ุฎุทุฃ

**ุงูุญู:**
- ุชุญูู ูู URL ูู webhook
- ูุฌุจ ุฃู ููุชูู ุจู `/api/notify/product-change`
- ุชุฃูุฏ ุฃู localtunnel ูุง ูุฒุงู ูุนูู

---

**ุงูุณููุงุฑูู C:** Logs ููุฌูุฏุฉ ุจู Status 200
```
Timestamp             Status
2025-01-08 11:30:00   200
```

โ **ูุนูุงูุง:** Webhook ูุตู ุจูุฌุงุญ!
โ ุงุฑุฌุน ููุฎุทูุฉ 4

---

## ๐งช ุงุฎุชุจุงุฑ ุชุฏุฑูุฌู

### Test 1: SQL Command

```sql
INSERT INTO distributor_surgical_tools (
  distributor_id,
  distributor_name,
  surgical_tool_id,
  description,
  price
) VALUES (
  auth.uid(),
  'Test Distributor',
  (SELECT id FROM surgical_tools LIMIT 1),
  'SQL Test',
  100.00
);
```

**ุงููุชูุฌุฉ:**
- โ ูุนูู: Webhook + ุฅุดุนุงุฑ ูุตู
- โ ูุง ูุนูู: ูุดููุฉ ูู webhook configuration

---

### Test 2: ูู ุงูุชุทุจูู

1. ุงูุชุญ ุงูุชุทุจูู
2. ุฃุถู ุฃุฏุงุฉ ุฌุฑุงุญูุฉ
3. **ุฑุงูุจ Terminal ููุฑุงู**

**ุงููุชูุฌุฉ:**
- โ ุชุดุงูุฏ `๐ฉ ุชููู webhook`: Webhook ูุนูู
- โ ูุง ุชุดุงูุฏ ุดูุก: Webhook ูุง ูุตู

---

## ๐ง ุงูุญููู ุงูุดุงุฆุนุฉ

### ุงูุญู 1: ุฃุนุฏ ุชุดุบูู ูู ุดูุก

```bash
# Terminal 1
Ctrl+C (ุฃููู npm start)
npm start

# Terminal 2  
Ctrl+C (ุฃููู localtunnel)
lt --port 3000

# ุงูุณุฎ URL ุงูุฌุฏูุฏ
# ุญุฏูุซ ุฌููุน webhooks ุจุงูู URL ุงูุฌุฏูุฏ!
```

---

### ุงูุญู 2: ุชุญูู ูู Auth User

**ุนูุฏ ุฅุถุงูุฉ ูู ุงูุชุทุจูู:**

```sql
-- ุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
SELECT auth.uid();
```

**ุฅุฐุง ุงููุชูุฌุฉ NULL:**
- ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูู
- ุณุฌูู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู

---

### ุงูุญู 3: ูุญุต Flutter Console

**ุนูุฏ ุฅุถุงูุฉ ุฃุฏุงุฉ ูู ุงูุชุทุจูู:**

**ุงูุชุญ Flutter Console (Run/Debug):**

ุงุจุญุซ ุนู:
```
โ ุชู ุฅุถุงูุฉ ุงูุฃุฏุงุฉ ุจูุฌุงุญ
```

ุฃู:
```
โ Error: ...
```

**ุฅุฐุง ูุฌุฏุช ุฎุทุฃุ ุฃุฑุณูู ูู!**

---

## ๐ Diagnostic Script

**ุดุบูู ูุฐุง ููุญุต ูู ุดูุก:**

```bash
# ูู D:\fieldawy_store

# Test 1: Server ูุนููุ
curl http://localhost:3000/api/notify/product-change -X POST -H "Content-Type: application/json" -d "{\"operation\":\"INSERT\",\"table\":\"distributor_surgical_tools\",\"product_name\":\"Test\",\"tab_name\":\"surgical\"}"

# Test 2: localtunnel ูุนููุ
curl https://little-mice-ask.loca.lt/api/notify/product-change -X POST -H "Content-Type: application/json" -d "{\"operation\":\"INSERT\",\"table\":\"distributor_surgical_tools\",\"product_name\":\"Test\",\"tab_name\":\"surgical\"}"

# Test 3: FCM ูุนููุ
node test_notification_direct.js
```

**ุฅุฐุง ูู ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช:** ุงููุดููุฉ ูู Supabase webhook

**ุฅุฐุง ุฃุญุฏูุง ูุดู:** ุงููุดููุฉ ูู ุฐูู ุงูุฌุฒุก

---

## ๐ฏ ุงูุฎุทูุฉ ุงูุชุงููุฉ

**ุฃุฎุจุฑูู:**

1. **ุนูุฏ ุงูุฅุถุงูุฉ ูู ุงูุชุทุจููุ ูู ุชุดุงูุฏ ุฑุณุงุฆู ูู Terminal (npm start)?**
   - ูุนู โ ูุงุฐุง ุชููู ุงูุฑุณุงุฆูุ
   - ูุง โ ูุง ุดูุก ูุธูุฑ

2. **ูู server + localtunnel ูุง ูุฒุงูุงู ูุนููุงูุ**

3. **ูู Webhook Logs ูู Supabase ูุงุฑุบุฉ ุฃู ูููุง entriesุ**

ูุณุฃุญู ุงููุดููุฉ ุจุฏูุฉ! ๐
