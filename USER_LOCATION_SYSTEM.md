# ๐ ูุธุงู ุชุญุฏูุฏ ูููุน ุงููุณุชุฎุฏููู - ุฏููู ูุงูู

## ๐ฏ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุถุงูุฉ ูุธุงู ูุชูุงูู ูุชุญุฏูุฏ ูุชุญุฏูุซ ูููุน **ุฌููุน ุงููุณุชุฎุฏููู** (ุฃุทุจุงุกุ ููุฒุนููุ ุดุฑูุงุช) ูุน ุฅููุงููุฉ:

โ **ุชุญุฏูุซ ุงููููุน ุงูุญุงูู ูุฏููุงู** - ูู ุดุงุดุฉ ุงูุฎุฑูุทุฉ ููุท (ูุง ุชุชุจุน ุชููุงุฆู)  
โ **ุนุฑุถ ุงููููุน ุนูู ุงูุฎุฑูุทุฉ** - ูุน ุชูููุฒ ูุงุถุญ ูููุณุชุฎุฏู  
โ **ุฑุคูุฉ ุงูุนูุงุฏุงุช ุงููุฑูุจุฉ** - ุญุณุจ ุงููุณุงูุฉ  
โ **Rate Limiting** - ุชุญุฏูุซ ูู 30 ุซุงููุฉ ูุญุฏ ุฃูุตู  
โ **ูุฌููุน ุงูุฃุฏูุงุฑ** - ููุฒุนุ ุดุฑูุฉุ ุทุจูุจ

---

## ๐ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ

### 1. ุชุญุฏูุซ ุงููููุน ุงูุญุงูู (ุฌููุน ุงูุฃุฏูุงุฑ)

#### **ูู ุดุงุดุฉ ุงูุฎุฑูุทุฉ ููุท:**
- ุฒุฑ ๐ **"ุชุญุฏูุซ ูููุนู ุงูุญุงูู"** ูู ุงูู AppBar
- ูุญุฏุซ ูููุน ุงููุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุฌุฏูู users)
- ูุนูุฏ ูุถุน ุงูุฎุฑูุทุฉ ุนูู ุงููููุน ุงูุฌุฏูุฏ
- Marker ุฃุฒุฑู ูููุฒ ูุธูุฑ ูููุณุชุฎุฏู ุงูุญุงูู
- ุฑุณุงุฆู ูุฌุงุญ/ูุดู ูุงุถุญุฉ

### 2. ุชุญุฏูุซ ูููุน ุงูุนูุงุฏุฉ (ููุฃุทุจุงุก ููุท)

#### **ูู ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช:**
- ุฒุฑ **"ุชุญุฏูุซ ูููุน ุงูุนูุงุฏุฉ"** (ููุฃุทุจุงุก ููุท)
- ูุญุฏุซ ุงููููุน ุงูุซุงุจุช ููุนูุงุฏุฉ (ุฌุฏูู clinics)
- ูุณุชุฎุฏู ููุนูุงุฏุงุช ุฐุงุช ุงููููุน ุงูุซุงุจุช

### 3. ุนุฑุถ ุนูู ุงูุฎุฑูุทุฉ

#### **Marker ุงููุณุชุฎุฏู ุงูุญุงูู:**
- ๐ต ุฏุงุฆุฑุฉ ุฒุฑูุงุก ูุจูุฑุฉ (50x50) ูุน ุธู ุฃุฒุฑู
- ุฃููููุฉ `person_pin_circle`
- ูุธูุฑ ููุท ุฅุฐุง ุญุฏูุซ ุงููุณุชุฎุฏู ูููุนู
- ูููุฒ ุนู markers ุงูุนูุงุฏุงุช

#### **Markers ุงูุนูุงุฏุงุช:**
- ๐ด ุฏุงุฆุฑุฉ ุญูุฑุงุก (40x40)
- ุฃููููุฉ `local_hospital`
- ูุงุจูุฉ ููููุฑ ูุนุฑุถ ุงูุชูุงุตูู

### 4. Rate Limiting
- **30 ุซุงููุฉ** ูุญุฏ ุฃุฏูู ุจูู ุงูุชุญุฏูุซุงุช
- ุฑุณุงูุฉ ูุงุถุญุฉ ุฅุฐุง ุญุงูู ุงููุณุชุฎุฏู ุงูุชุญุฏูุซ ุจุณุฑุนุฉ
- ูููุน ุงุณุชูุฒุงู ุงูุจุทุงุฑูุฉ ูุงูู API

---

## ๐ ุงูุชุบููุฑุงุช ุงูุชูููุฉ

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### **ุฌุฏูู users:**
```sql
ALTER TABLE users ADD COLUMN:
- last_latitude (DOUBLE PRECISION)
- last_longitude (DOUBLE PRECISION)  
- last_location_update (TIMESTAMP)
```

#### **ุฏูุงู Supabase ุฌุฏูุฏุฉ:**

**`update_user_location(user_id, latitude, longitude)`**
- ุชุญุฏูุซ ูููุน ุงููุณุชุฎุฏู
- Rate limiting ูุฏูุฌ (30 ุซุงููุฉ)
- SECURITY DEFINER

**`get_nearby_clinics(latitude, longitude, radius_km)`**
- ุฅุฑุฌุงุน ุงูุนูุงุฏุงุช ุงููุฑูุจุฉ ูุฑุชุจุฉ ุญุณุจ ุงููุณุงูุฉ
- ุงุณุชุฎุฏุงู Haversine formula ูููุณุงูุฉ ุงูุฏูููุฉ
- SECURITY DEFINER

### 2. UserModel

**ุญููู ุฌุฏูุฏุฉ:**
```dart
final double? lastLatitude;
final double? lastLongitude;
final DateTime? lastLocationUpdate;
```

**HiveField annotations:**
- `@HiveField(12)` ูู lastLatitude
- `@HiveField(13)` ูู lastLongitude  
- `@HiveField(14)` ูู lastLocationUpdate

### 3. UserRepository

**ุฏุงูุฉ ุฌุฏูุฏุฉ:**
```dart
Future<bool> updateUserLocation({
  required String userId,
  required double latitude,
  required double longitude,
})
```

- ุชุณุชุฏุนู `update_user_location` RPC
- ูุนุงูุฌุฉ ุฃุฎุทุงุก Rate limiting
- Invalidate cache

### 4. ุดุงุดุฉ ุงูุฎุฑูุทุฉ

**ุชุญุฏูุซุงุช:**
- ุนุฑุถ ูููุน ุงููุณุชุฎุฏู ุงูุญุงูู
- ุฒุฑ ุชุญุฏูุซ ุงููููุน ูู AppBar
- ุชุญุฏูุซ Markers ุนูุฏ ุงูุชุญุฏูุซ
- Loading indicator ุฃุซูุงุก ุงูุชุญุฏูุซ

### 5. ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช

**ูุณู ุฌุฏูุฏ: "ุงููููุน"**
- **ุชุญุฏูุซ ูููุนู** (ููุฌููุน)
- **ุชุญุฏูุซ ูููุน ุงูุนูุงุฏุฉ** (ููุฃุทุจุงุก ููุท)

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ูููุณุชุฎุฏููู (ุฌููุน ุงูุฃุฏูุงุฑ):

#### **ุชุญุฏูุซ ุงููููุน ุงูุญุงูู:**
1. ุงูุชุญ **"ุฎุฑูุทุฉ ุงูุนูุงุฏุงุช"** ๐บ๏ธ (ูู ุงูุฅุนุฏุงุฏุงุช ุฃู ุงููุงุฆูุฉ)
2. ุงุถุบุท ุนูู ุฒุฑ ๐ **"ุชุญุฏูุซ ูููุนู ุงูุญุงูู"** ูู ุงูุฃุนูู
3. ุงููุญ ุฅุฐู ุงููููุน ุฅุฐุง ุทููุจ ููู
4. ุงูุชุธุฑ ููููุงู... โณ
5. โ ุณุชุฑู ุฑุณุงูุฉ ูุฌุงุญ ูุณูุธูุฑ marker ุฃุฒุฑู ููููุนู
6. ุณุชุชุญุฑู ุงูุฎุฑูุทุฉ ููููุนู ุงูุฌุฏูุฏ ุชููุงุฆูุงู

**ููุงุญุธุฉ:** ููููู ุงูุชุญุฏูุซ ูู 30 ุซุงููุฉ ูุญุฏ ุฃูุตู

### ููุฃุทุจุงุก (ุฅุถุงูู):

#### **ุชุญุฏูุซ ูููุน ุงูุนูุงุฏุฉ ุงูุซุงุจุช:**
1. ุงูุชุญ **ุงูุฅุนุฏุงุฏุงุช** โ๏ธ
2. ูู ูุณู **"ูููุน ุงูุนูุงุฏุฉ"**
3. ุงุถุบุท **"ุชุญุฏูุซ ูููุน ุงูุนูุงุฏุฉ"**
4. ูุฐุง ูุญุฏูุซ ุงููููุน **ุงูุซุงุจุช** ููุนูุงุฏุฉ (ุฌุฏูู clinics)
5. ูุธูุฑ ูู marker ุฃุญูุฑ ุนูู ุงูุฎุฑูุทุฉ

---

## ๐ ุงููุฑู ุจูู ุงููููุนูู

### 1. ุงููููุน ุงูุญุงูู ูููุณุชุฎุฏู (ุฌุฏูู users)
- ๐ฑ **ูุชุบูุฑ** - ููุญุฏูุซ ูุฏููุงู ูู ุดุงุดุฉ ุงูุฎุฑูุทุฉ
- ๐ฅ **ูุฌููุน ุงูุฃุฏูุงุฑ** - ุฃุทุจุงุกุ ููุฒุนููุ ุดุฑูุงุช
- ๐ต **Marker ุฃุฒุฑู** ุนูู ุงูุฎุฑูุทุฉ
- ๐ **ุงูุงุณุชุฎุฏุงู**: 
  - ูุนุฑูุฉ ุงููููุน ุงูุญุงูู ูููุณุชุฎุฏู
  - ุฑุคูุฉ ุงูุนูุงุฏุงุช ุงููุฑูุจุฉ ูู ูููุนู
  - ููููุฒุนูู: ูุนุฑูุฉ ุงูุนูุงุฏุงุช ูู ุงูููุทูุฉ ุงูุญุงููุฉ

### 2. ูููุน ุงูุนูุงุฏุฉ ุงูุซุงุจุช (ุฌุฏูู clinics)
- ๐ฅ **ุซุงุจุช** - ูููุน ุงูุนูุงุฏุฉ ุงูุฏุงุฆู
- ๐จโโ๏ธ **ููุฃุทุจุงุก ููุท**
- ๐ด **Marker ุฃุญูุฑ** ุนูู ุงูุฎุฑูุทุฉ
- ๐บ๏ธ **ุงูุงุณุชุฎุฏุงู**: 
  - ุนุฑุถ ุงูุนูุงุฏุงุช ููุฌููุน ุนูู ุงูุฎุฑูุทุฉ
  - ูุนุฑูุฉ ูููุน ุนูุงุฏุฉ ูุนููุฉ
  - ููููุฒุนูู: ูุนุฑูุฉ ุฃูู ุงูุนูุงุฏุงุช ูุฒูุงุฑุชูุง

---

## ๐ ูุซุงู ุณููุงุฑูู ุงูุงุณุชุฎุฏุงู

### **ููุฒุน ูู ุฌููุฉ:**

1. **ูู ููุทูุฉ ุงููุนุงุฏู**: 
   - ููุชุญ ุงูุชุทุจูู
   - ูุฐูุจ ูู "ุฎุฑูุทุฉ ุงูุนูุงุฏุงุช"
   - ูุถุบุท ๐ "ุชุญุฏูุซ ูููุนู ุงูุญุงูู"
   - โ ุชู ุญูุธ ูููุนู ูู ุงููุนุงุฏู

2. **ุนูู ุงูุฎุฑูุทุฉ**:
   - ูุฑู ูููุนู ุงูุญุงูู (๐ต Marker ุฃุฒุฑู ูู ุงููุนุงุฏู)
   - ูุฑู ุงูุนูุงุฏุงุช ุงููุฑูุจุฉ ูู ุงููุนุงุฏู (๐ด Markers ุญูุฑุงุก)
   - ููููู ุงูุถุบุท ุนูู ุฃู ุนูุงุฏุฉ ูุฑุคูุฉ ุงูุชูุงุตูู

3. **ุนูุฏ ุงูุงูุชูุงู ููุฏููุฉ ูุตุฑ**:
   - ูู ุงูุทุฑููุ ูุตู ููุฏููุฉ ูุตุฑ
   - ููุชุญ ุงูุฎุฑูุทุฉ ูุฑุฉ ุฃุฎุฑู
   - ูุถุบุท ๐ "ุชุญุฏูุซ ูููุนู ุงูุญุงูู"
   - โ ุชู ุชุญุฏูุซ ูููุนู ููุฏููุฉ ูุตุฑ
   - ๐ต Marker ููุชูู ููููุนู ุงูุฌุฏูุฏ
   - ูุฑู ุงูุนูุงุฏุงุช ุงููุฑูุจุฉ ุงูุฌุฏูุฏุฉ ูู ูุฏููุฉ ูุตุฑ

### **ุทุจูุจ ููุชุญ ุนูุงุฏุฉ ุฌุฏูุฏุฉ:**

1. **ุฃูู ูุฑุฉ**: 
   - ุนูุฏ ุชุณุฌูู ุงูุฏุฎููุ ููุทูุจ ููู ุชุญุฏูุฏ ูููุน ุงูุนูุงุฏุฉ
   - ูุญุฏุฏ ุงููููุน โ ููุญูุธ ูู ุฌุฏูู clinics
   - ๐ด ุชุธูุฑ ุนูุงุฏุชู ุนูู ุงูุฎุฑูุทุฉ ููุฌููุน

2. **ุฅุฐุง ุงูุชููุช ุงูุนูุงุฏุฉ**:
   - ูุฐูุจ ููุฅุนุฏุงุฏุงุช
   - "ุชุญุฏูุซ ูููุน ุงูุนูุงุฏุฉ"
   - ูุญุฏุซ ุงููููุน ุงูุซุงุจุช ุงูุฌุฏูุฏ

3. **ุฅุฐุง ูุงู ูู ุฌููุฉ ุฎุงุฑุฌูุฉ**:
   - ููุชุญ ุงูุฎุฑูุทุฉ
   - ูุถุบุท ๐ ูุชุญุฏูุซ ูููุนู ุงูุญุงูู
   - ูุง ูุคุซุฑ ุนูู ูููุน ุงูุนูุงุฏุฉ ุงูุซุงุจุช

---

## ๐ก๏ธ ุงูุฃูุงู ูุงูุญูุงูุฉ

### 1. Rate Limiting
```sql
-- ูุง ูููู ุงูุชุญุฏูุซ ุฃูุซุฑ ูู ูุฑุฉ ูู 30 ุซุงููุฉ
IF last_location_update > NOW() - INTERVAL '30 seconds' THEN
  RAISE EXCEPTION 'Please wait 30 seconds...'
END IF
```

### 2. RLS Policies
- โ ูู ูุณุชุฎุฏู ููููู ุชุญุฏูุซ ูููุนู ููุท
- โ ุงูุฃุฏูู ููููู ุฑุคูุฉ ุฌููุน ุงูููุงูุน
- โ ูุง ูููู ูููุณุชุฎุฏููู ุฑุคูุฉ ููุงูุน ุจุนุถูู (ูู ุฌุฏูู users)

### 3. Permissions
- โ ุฅุฐู ุงููููุน ูุทููุจ
- โ ุงููุณุชุฎุฏู ูุชุญูู ูุชู ูุดุงุฑู ูููุนู
- โ ูุง ูุชู ุงูุชุชุจุน ุงูุชููุงุฆู

---

## ๐ ุงููููุงุช ุงููุถุงูุฉ/ุงููุนุฏูุฉ

### SQL Migration:
```
supabase/migrations/20250127_add_location_to_users.sql
```
- ุฅุถุงูุฉ ุฃุนูุฏุฉ ุงููููุน ูุฌุฏูู users
- ุฏุงูุฉ `update_user_location`
- ุฏุงูุฉ `get_nearby_clinics`

### Flutter Code:

**Models:**
- โ `lib/features/authentication/domain/user_model.dart` (ุชุญุฏูุซ)

**Repositories:**
- โ `lib/features/authentication/data/user_repository.dart` (ุชุญุฏูุซ)

**Screens:**
- โ `lib/features/clinics/presentation/screens/clinics_map_screen.dart` (ุชุญุฏูุซ)
- โ `lib/features/settings/presentation/screens/settings_screen.dart` (ุชุญุฏูุซ)

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1. ุชุดุบูู SQL Migration
```bash
# ูู Supabase SQL Editor
-- ุดุบูู ูุญุชูู:
supabase/migrations/20250127_add_location_to_users.sql
```

### 2. ุฅุนุงุฏุฉ build Hive models (ุฅุฐุง ูุฒู)
```bash
flutter packages pub run build_runner build --delete-conflicting-outputs
```

### 3. ุงุฎุชุจุงุฑ ุงูููุฒุงุช
```bash
flutter run
```

**ุงูุณููุงุฑูููุงุช:**
1. โ ุชุญุฏูุซ ุงููููุน ูู ุงูุฅุนุฏุงุฏุงุช
2. โ ุชุญุฏูุซ ุงููููุน ูู ุงูุฎุฑูุทุฉ
3. โ ุงูุชุญูู ูู Rate Limiting (ูุญุงููุฉ ุชุญุฏูุซ ุณุฑูุน)
4. โ ุนุฑุถ Marker ุงููุณุชุฎุฏู ุนูู ุงูุฎุฑูุทุฉ
5. โ ุฑุคูุฉ ุงูุนูุงุฏุงุช ุงููุฑูุจุฉ

---

## ๐ก ูุตุงุฆุญ ููุงุณุชุฎุฏุงู ุงูุฃูุซู

### ูููุณุชุฎุฏููู:
1. **ุญุฏูุซ ูููุนู** ุนูุฏ ุงููุตูู ูููุทูุฉ ุฌุฏูุฏุฉ
2. **ูุง ุชุญุงูู ุงูุชุญุฏูุซ ุจุณุฑุนุฉ** - ุงูุชุธุฑ 30 ุซุงููุฉ
3. **ุชุฃูุฏ ูู ุงูุฃุฐููุงุช** - ุงุณูุญ ุจุงููุตูู ูููููุน

### ูููุทูุฑูู:
1. **ูุฑุงูุจุฉ ุงูู Logs** ููุชุฃูุฏ ูู ุนูู ุงูู RPC
2. **ุงุฎุชุจุงุฑ Rate Limiting** ููุชุญูู ูู ุงูุญูุงูุฉ
3. **ุชุญุณูู ุงูุฃุฏุงุก** ุจุนุฏ ุฅุถุงูุฉ ุจูุงูุงุช ูุซูุฑุฉ

---

## ๐ฎ ููุฒุงุช ูุณุชูุจููุฉ ูุญุชููุฉ

- [ ] **ุณุฌู ุงูููุงูุน** (Location History)
- [ ] **ุชุชุจุน ุงููุณุงุฑ** (Route Tracking)
- [ ] **ุฅุดุนุงุฑุงุช ุงููุฑุจ** (Proximity Notifications)
- [ ] **ุชุญูููุงุช** (Analytics ููููุงุทู ุงูุฃูุซุฑ ูุดุงุทุงู)
- [ ] **ุฎุฑุงุฆุท ุญุฑุงุฑูุฉ** (Heat Maps)
- [ ] **ูุดุงุฑูุฉ ุงููููุน ุงููุจุงุดุฑ** (Live Location Sharing)

---

## ๐ ุฅุญุตุงุฆูุงุช ุงููุธุงู

### ูุจู ุงูุชุญุฏูุซ:
- โ ููุท ุงูุฃุทุจุงุก ูููููู ุชุญุฏูุฏ ุงููููุน (clinics ููุท)
- โ ูุง ูููู ููููุฒุนูู/ุงูุดุฑูุงุช ุชุญุฏูุฏ ููุงูุนูู
- โ ูุง ููุฌุฏ rate limiting

### ุจุนุฏ ุงูุชุญุฏูุซ:
- โ **ุฌููุน ุงูุฃุฏูุงุฑ** ูููููู ุชุญุฏูุฏ ููุงูุนูู
- โ **ุฌุฏูู users** ูุญุชูู ุนูู ูููุน ูู ูุณุชุฎุฏู
- โ **Rate limiting** ูุฏูุฌ (30 ุซุงููุฉ)
- โ **Markers ูููุฒุฉ** ููู ููุน (ูุณุชุฎุฏู/ุนูุงุฏุฉ)
- โ **ุฏูุงู Supabase** ูุญุณููุฉ ูุขููุฉ

---

## โ Checklist ููุฅุนุฏุงุฏ

- [ ] ุชุดุบูู SQL migration: `20250127_add_location_to_users.sql`
- [ ] ุงูุชุญูู ูู ุฃุฐููุงุช ุงููููุน (Android/iOS)
- [ ] ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุงููููุน ูู ุงูุฅุนุฏุงุฏุงุช
- [ ] ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุงููููุน ูู ุงูุฎุฑูุทุฉ
- [ ] ุงูุชุญูู ูู Rate Limiting
- [ ] ุงูุชุญูู ูู ุนุฑุถ Markers ุนูู ุงูุฎุฑูุทุฉ
- [ ] ุงุฎุชุจุงุฑ ูุน ุฃุฏูุงุฑ ูุฎุชููุฉ (ุทุจูุจุ ููุฒุนุ ุดุฑูุฉ)

---

## ๐ ุงูุฏุนู

### ูุดุงูู ุดุงุฆุนุฉ:

**โ "ุชุนุฐุฑ ุงูุญุตูู ุนูู ุงููููุน"**
- โ ุชุญูู ูู ุฃุฐููุงุช ุงูุชุทุจูู
- โ ุชุฃูุฏ ูู ุชูุนูู ุฎุฏูุงุช ุงููููุน

**โฐ "ูุฑุฌู ุงูุงูุชุธุงุฑ 30 ุซุงููุฉ"**
- โ ูุฐุง ุทุจูุนู - Rate limiting ูุดุท
- โ ุงูุชุธุฑ ููููุงู ุซู ุญุงูู ูุฑุฉ ุฃุฎุฑู

**๐บ๏ธ "ูุง ูุธูุฑ ูููุนู ุนูู ุงูุฎุฑูุทุฉ"**
- โ ุญุฏูุซ ูููุนู ุฃููุงู ูู ุงูุฅุนุฏุงุฏุงุช ุฃู ุงูุฎุฑูุทุฉ
- โ ุชุญูู ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช

---

**ุชู ุจูุฌุงุญ! ๐**

ูุธุงู ุชุญุฏูุฏ ูููุน ุงููุณุชุฎุฏููู ุฌุงูุฒ ููุนูู ูุฌููุน ุงูุฃุฏูุงุฑ!
