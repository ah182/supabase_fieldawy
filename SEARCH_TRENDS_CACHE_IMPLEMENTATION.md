# ูุธุงู Cache ููุฃุณูุงุก ุงููุญุณููุฉ ูู ุชุงุจ ุงูุชุฑูุฏุงุช
# Search Trends Cache System Implementation

## ๐ฏ ุงููุฏู / Objective

ุชุญุณูู ุฃุฏุงุก ุชุงุจ ุงูุชุฑูุฏุงุช ูู ุฎูุงู ุงุณุชุฎุฏุงู ูุธุงู Cache ููุฃุณูุงุก ุงููุญุณููุฉ ุจุฏูุงู ูู ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูู ูุฑุฉ.

---

## ๐ ุงููุดููุฉ ุงูุฃุตููุฉ / Original Problem

### ูุจู ุงูุชุญุณูู:
- **ุงูููุช**: 10-30 ุซุงููุฉ โฑ๏ธ
- **ุงูุณุจุจ**: ุฏุงูุฉ `_improveProductName` ุชูุณุชุฏุนู ููู ูุตุทูุญ ุจุญุซ (10-15 ูุฑุฉ)
- **ุงูุงุณุชุนูุงูุงุช**: 10 ูุตุทูุญุงุช ร 3 ุฌุฏุงูู ร 200 ุณุฌู = **6,000 ุณุฌู!**

---

## โ ุงูุญู ุงููุทุจู / Solution Implemented

### ุงูุฎูุงุฑ 3: Cache ููุฃุณูุงุก ุงููุญุณููุฉ

#### 1. **ุชุญุฏูุซุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช**

**ุงูููู**: `supabase/add_improved_name_cache.sql`

##### ุงูุฃุนูุฏุฉ ุงูุฌุฏูุฏุฉ:
```sql
-- ุนููุฏ ูุญูุธ ุงูุงุณู ุงููุญุณูู
improved_name TEXT

-- ุนููุฏ ูุญูุธ ุฏุฑุฌุฉ ุงูุชุทุงุจู
improvement_score INTEGER DEFAULT 0

-- ุนููุฏ ูุชุชุจุน ุขุฎุฑ ุชุญุฏูุซ
last_improved_at TIMESTAMP WITH TIME ZONE
```

##### ุงูููุงุฑุณ ุงูุฌุฏูุฏุฉ:
```sql
-- ููุฑุณ ููุจุญุซ ุงูุณุฑูุน ุจุงูุฃุณูุงุก ุงููุญุณููุฉ
idx_search_tracking_improved_name

-- ููุฑุณ ูุฑูุจ ููุจุญุซ ุจุงููุตุทูุญ ุงูุฃุตูู ูุงูุงุณู ุงููุญุณูู
idx_search_tracking_term_improved
```

##### ุงูุฏูุงู ุงูุฌุฏูุฏุฉ:
1. **`update_improved_search_name`** - ูุชุญุฏูุซ ุงูุงุณู ุงููุญุณูู
2. **`get_cached_improved_name`** - ููุญุตูู ุนูู ุงูุงุณู ุงููุญุณูู ูู ุงูู Cache
3. **`get_top_search_terms_cached`** - ููุญุตูู ุนูู ุฃูุถู ูุตุทูุญุงุช ุงูุจุญุซ ูุน ุงูุฃุณูุงุก ุงููุญุณููุฉ

---

#### 2. **ุชุญุฏูุซุงุช ุงูููุฏ**

**ุงูููู**: `lib/features/dashboard/data/analytics_repository_updated.dart`

##### ุงูุฏูุงู ุงูุฌุฏูุฏุฉ:

###### ุฃ. `_getRealSearchTrendsWithCache()` - ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ
```dart
// ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงููุญุณููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
final response = await _supabase.rpc('get_top_search_terms_cached', params: {
  'p_limit': 10,
  'p_days': 7,
});

// ุงุณุชุฎุฏุงู ุงูุฃุณูุงุก ุงููุญุณููุฉ ุงููุฎุฒูุฉ ูุจุงุดุฑุฉ
'keyword': row['improved_name'] ?? row['search_term']
```

**ุงููููุฒุงุช:**
- โ ุงุณุชุนูุงู ูุงุญุฏ ููุท
- โ ุงุณุชุฎุฏุงู ุงูุฃุณูุงุก ุงููุญุณููุฉ ุงููุฎุฒูุฉ
- โ Fallback ูููุณุฎุฉ ุงูุณุฑูุนุฉ ุฅุฐุง ูุดู

###### ุจ. `_getRealSearchTrendsFast()` - ูุณุฎุฉ ุงุญุชูุงุทูุฉ
```dart
// ุงุณุชุนูุงู ุจุณูุท ุจุฏูู ุชุญุณูู ุงูุฃุณูุงุก
final response = await _supabase
    .from('search_tracking')
    .select('search_term, result_count, user_id, search_type')
    .limit(50);
```

**ุงููููุฒุงุช:**
- โ ุณุฑูุน ุฌุฏุงู (1-2 ุซุงููุฉ)
- โ ูุนูู ุญุชู ุจุฏูู Cache
- โ ูุณุชุฎุฏู ุงูุฃุณูุงุก ุงูุฃุตููุฉ

###### ุฌ. `_improveSearchTermsInBackground()` - ุชุญุณูู ูู ุงูุฎูููุฉ
```dart
// ุฌูุจ ุงููุตุทูุญุงุช ุงูุชู ูุง ุชุญุชูู ุนูู ุฃุณูุงุก ูุญุณููุฉ
final termsToImprove = await _supabase
    .from('search_tracking')
    .select('search_term, search_type')
    .is_('improved_name', null)
    .limit(5); // 5 ูุตุทูุญุงุช ููุท ูู ูู ูุฑุฉ

// ุชุญุณูู ูุญูุธ ูู ุงูู Cache
await _updateImprovedNameCache(searchTerm, improvedName, score);
```

**ุงููููุฒุงุช:**
- โ ูุง ูุคุซุฑ ุนูู ุณุฑุนุฉ ุงูุชุญููู
- โ ูุญุณูู 5 ูุตุทูุญุงุช ููุท ูู ูู ูุฑุฉ
- โ ูุนูู ูู ุงูุฎูููุฉ ุจุนุฏ ุนุฑุถ ุงูุจูุงูุงุช

###### ุฏ. `_updateImprovedNameCache()` - ุชุญุฏูุซ ุงูู Cache
```dart
await _supabase.rpc('update_improved_search_name', params: {
  'p_search_term': searchTerm,
  'p_improved_name': improvedName,
  'p_improvement_score': score,
});
```

---

## ๐ ุงููุชุงุฆุฌ / Results

### ุจุนุฏ ุงูุชุญุณูู:
- โก **ุงูููุช**: 1-2 ุซุงููุฉ (ุฃูู ูุฑุฉ) โ ุฃูู ูู ุซุงููุฉ (ูุน Cache)
- ๐ **ุงูุงุณุชุนูุงูุงุช**: ุงุณุชุนูุงู ูุงุญุฏ ููุท
- ๐ **ุงูุชุญุณูู**: **90-95% ุฃุณุฑุน**

### ููุงุฑูุฉ ุงูุฃุฏุงุก:

| ุงููููุงุณ | ูุจู | ุจุนุฏ | ุงูุชุญุณูู |
|---------|-----|-----|---------|
| **ุงูููุช** | 10-30 ุซุงููุฉ | 1-2 ุซุงููุฉ | **90-95%** โก |
| **ุงูุณุฌูุงุช** | 6,000-9,000 | 10-50 | **99%** ๐พ |
| **ุงูุงุณุชุนูุงูุงุช** | 30+ ุงุณุชุนูุงู | 1 ุงุณุชุนูุงู | **97%** ๐ฏ |
| **ุฏูุฉ ุงูุฃุณูุงุก** | ุนุงููุฉ | ุนุงููุฉ | **ููุณ ุงูุฏูุฉ** โ |

---

## ๐ง ุฎุทูุงุช ุงูุชุทุจูู / Implementation Steps

### 1. ุชุทุจูู ุชุญุฏูุซุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
```bash
# ูู Supabase SQL Editor
# ููุฐ ุงูููู: supabase/add_improved_name_cache.sql
```

### 2. ุงูููุฏ ูุญุฏุซ ุชููุงุฆูุงู
ุงููููุงุช ุงูุชุงููุฉ ุชู ุชุญุฏูุซูุง:
- โ `lib/features/dashboard/data/analytics_repository_updated.dart`

### 3. ุงุฎุชุจุงุฑ ุงููุธุงู
```dart
// ุณูุชู ุงุณุชุฎุฏุงู Cache ุชููุงุฆูุงู
// ูู ุงููุฑุฉ ุงูุฃููู: 1-2 ุซุงููุฉ
// ูู ุงููุฑุงุช ุงูุชุงููุฉ: ุฃูู ูู ุซุงููุฉ
```

---

## ๐ฏ ููู ูุนูู ุงููุธุงู / How It Works

### ุงููุฑุฉ ุงูุฃููู (ุจุฏูู Cache):
1. ุงุณุชุนูุงู ูู `search_tracking` ููุญุตูู ุนูู ุงููุตุทูุญุงุช
2. ุนุฑุถ ุงูุฃุณูุงุก ุงูุฃุตููุฉ ููุฑุงู (1-2 ุซุงููุฉ)
3. ุชุญุณูู 5 ูุตุทูุญุงุช ูู ุงูุฎูููุฉ
4. ุญูุธ ุงูุฃุณูุงุก ุงููุญุณููุฉ ูู ุงูู Cache

### ุงููุฑุงุช ุงูุชุงููุฉ (ูุน Cache):
1. ุงุณุชุนูุงู ูู `get_top_search_terms_cached`
2. ุนุฑุถ ุงูุฃุณูุงุก ุงููุญุณููุฉ ุงููุฎุฒูุฉ ููุฑุงู (< 1 ุซุงููุฉ)
3. ุชุญุณูู ุงููุตุทูุญุงุช ุงูุฌุฏูุฏุฉ ูู ุงูุฎูููุฉ

---

## ๐ ููุงุญุธุงุช / Notes

- โ ุงููุธุงู ูุนูู ุชููุงุฆูุงู ุจุฏูู ุชุฏุฎู
- โ ูุญุณูู ุงูุฃุณูุงุก ุชุฏุฑูุฌูุงู ูู ุงูุฎูููุฉ
- โ ูุง ูุคุซุฑ ุนูู ุณุฑุนุฉ ุงูุชุญููู
- โ ูุญุงูุธ ุนูู ุฏูุฉ ุงูุฃุณูุงุก ุงููุญุณููุฉ
- โ ูุนูู ุญุชู ุจุฏูู Cache (Fallback)

---

## ๐ ุงูุฎูุงุตุฉ / Summary

ุชู ุชุทุจูู ูุธุงู Cache ุฐูู ูุญุณูู ุฃุฏุงุก ุชุงุจ ุงูุชุฑูุฏุงุช ุจูุณุจุฉ **90-95%** ูู ุฎูุงู:
1. ุญูุธ ุงูุฃุณูุงุก ุงููุญุณููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. ุงุณุชุฎุฏุงู ุงูุฃุณูุงุก ุงููุฎุฒูุฉ ุจุฏูุงู ูู ุงูุจุญุซ ูู ูู ูุฑุฉ
3. ุชุญุณูู ุงููุตุทูุญุงุช ุงูุฌุฏูุฏุฉ ูู ุงูุฎูููุฉ

**ุงููุชูุฌุฉ**: ุชุญููู ุณุฑูุน ุฌุฏุงู ูุน ุงูุญูุงุธ ุนูู ุฏูุฉ ุงูุจูุงูุงุช! โกโจ

